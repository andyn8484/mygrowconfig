- sensor:
    #    - name:
    #      unique_id:
    #      icon:
    #      device_class:
    #      state_class:
    #      unit_of_measurement: ""
    #      state: "{{  }}"

    - name: "Vapor Pressure Deficit"
      unique_id: vapor_pressure_deficit
      device_class: atmospheric_pressure
      state_class: measurement
      unit_of_measurement: "kPa"
      state: >
        {% set T = ((states('sensor.tent_temperature') | float) - 32) * 5/9 %}
        {% set RH = states('sensor.tent_humidity')|float %}
        {% set SVP = 0.61078 * e ** (17.2694 * T / (T + 238.3)) %}
        {% set VPD = ((100-RH) / 100) * SVP %}
        {{-VPD | round(2) -}}

    ##############Templates to calculate amp draw on energy sensors########################################

    - name: "Nutrient Pump Current"
      unique_id: shellypro4pm_84cca87fa4f4_current_1
      icon: mdi:current-ac
      device_class: current
      state_class: measurement
      unit_of_measurement: "A"
      state: "{{ (states('sensor.shellypro4pm_84cca87fa4f4_power_1') | float / states('sensor.shellypro4pm_84cca87fa4f4_voltage_1') | float ) | round(2)  }}"

    - name: "Air Pump Current"
      unique_id: shellypro4pm_84cca87fa4f4_current_2
      icon: mdi:current-ac
      device_class: current
      state_class: measurement
      unit_of_measurement: "A"
      state: "{{ (states('sensor.shellypro4pm_84cca87fa4f4_power_2') | float / states('sensor.shellypro4pm_84cca87fa4f4_voltage_1') | float) | round(2)  }}"

    - name: "Dehumidifier Current"
      unique_id: shellypro4pm_84cca87fa4f4_current_3
      icon: mdi:current-ac
      device_class: current
      state_class: measurement
      unit_of_measurement: "A"
      state: "{{ (states('sensor.shellypro4pm_84cca87fa4f4_power_3') | float / states('sensor.shellypro4pm_84cca87fa4f4_voltage_3') | float ) | round(2)  }}"

    - name: "Humidifier Current"
      unique_id: shellypro4pm_84cca87fa4f4_current_4
      icon: mdi:current-ac
      device_class: current
      state_class: measurement
      unit_of_measurement: "A"
      state: "{{ (states('sensor.shellypro4pm_84cca87fa4f4_power_4') | float / states('sensor.shellypro4pm_84cca87fa4f4_voltage_4') | float ) | round(2)  }}"

    - name: "Grow Light Current"
      unique_id: shellypro4pm_884cca87f1ae0_switch01_current_1
      icon: mdi:current-ac
      device_class: current
      state_class: measurement
      unit_of_measurement: "A"
      state: "{{ (states('sensor.shellypro4pm_84cca87f1ae0_power_1') | float / states('sensor.shellypro4pm_84cca87f1ae0_voltage_1') | float ) | round(2)  }}"

    - name: "Tent Exhaust Current"
      unique_id: shellypro4pm_84cca87f1ae0_current_2
      icon: mdi:current-ac
      device_class: current
      state_class: measurement
      unit_of_measurement: "A"
      state: "{{ (states('sensor.shellypro4pm_84cca87f1ae0_power_2') | float / states('sensor.shellypro4pm_84cca87f1ae0_voltage_2') | float ) | round(2)  }}"

    - name: "Bottom Circulation Fan Current"
      unique_id: shellypro4pm_84cca87f1ae0_current_3
      icon: mdi:current-ac
      device_class: current
      state_class: measurement
      unit_of_measurement: "A"
      state: "{{ (states('sensor.shellypro4pm_84cca87f1ae0_power_3') | float / states('sensor.shellypro4pm_84cca87f1ae0_voltage_3') | float ) | round(2)  }}"

    - name: "Top Circulation Fan Current"
      unique_id: shellypro4pm_84cca87f1ae0_current_4
      icon: mdi:current-ac
      state_class: measurement
      state: "{{ (states('sensor.shellypro4pm_84cca87f1ae0_power_4') | float / states('sensor.shellypro4pm_84cca87f1ae0_voltage_4') | float ) | round(2)  }}"
      unit_of_measurement: "A"

    - name: "Total Current"
      unique_id: shellyem_e45229_channel_1_current
      icon: mdi:current-ac
      state_class: measurement
      state: "{{ (states('sensor.shellyem_e45229_channel_1_power') | float / states('sensor.shellyem_e45229_channel_1_voltage') | float ) | round(2)  }}"
      unit_of_measurement: "A"

    ####################Converting Dates to Week Count##########################################
    - name: "Weeks Since Sprout"
      unique_id: weeks_since_sprout
      state_class: measurement
      unit_of_measurement: "Weeks"
      state: "{{ (states('sensor.anniversary_days_since_sprout') | float / 7 ) | round(0, 'floor')  }}"

    - name: "Weeks Since Flower"
      unique_id: weeks_since_flower
      state_class: measurement
      unit_of_measurement: "Weeks"
      state: "{{ (states('sensor.anniversary_flipped_to_flower') | float / 7 ) | round(0, 'floor')  }}"

    - name: "Weeks Remaining"
      unique_id: weeks_remaining
      state_class: measurement
      unit_of_measurement: "Weeks"
      state: "{{ 12 - (states('sensor.weeks_since_flower')| float ) | round(0, 'floor')  }}"

    ##################Threshold min/max for controlled variables (pH, Temps, Humidity)

    - name: "pH Threshold Max"
      unique_id: ph_setmax
      icon: mdi:ph
      state_class: measurement
      unit_of_measurement: "pH"
      state: "{{ states('input_number.ph_target') | float + states('input_number.ph_tolerance') | float }}"

    - name: "pH Threshold Min"
      unique_id: ph_setmin
      icon: mdi:ph
      state_class: measurement
      unit_of_measurement: "pH"
      state: "{{ states('input_number.ph_target') | float - states('input_number.ph_tolerance') | float }}"

    - name: "Air Temp Threshold Max"
      unique_id: tenttemp_setmax
      icon: mdi:thermometer
      state_class: measurement
      device_class: temperature
      unit_of_measurement: "째F"
      state: "{{ states('input_number.air_temperature_target') | float + states('input_number.air_temperature_tolerance') | float }}"

    - name: "Air Temp Threshold Min"
      unique_id: tenttemp_setmin
      icon: mdi:thermometer
      state_class: measurement
      device_class: temperature
      unit_of_measurement: "째F"
      state: "{{ states('input_number.air_temperature_target') | float - states('input_number.air_temperature_tolerance') | float }}"

    - name: "Humidity Threshold Max"
      unique_id: tenthum_setmax
      icon: mdi:cloud-percent
      state_class: measurement
      device_class: humidity
      unit_of_measurement: "%"
      state: "{{ states('input_number.humidity_target') | float + states('input_number.humidity_tolerance') | float }}"

    - name: "Humidity Threshold Min"
      unique_id: tenthum_setmin
      icon: mdi:cloud-percent
      state_class: measurement
      device_class: humidity
      unit_of_measurement: "%"
      state: "{{ states('input_number.humidity_target') | float - states('input_number.humidity_tolerance') | float }}"

    - name: "Water Temp Threshold Max"
      unique_id: watertemp_setmax
      icon: mdi:thermometer-water
      state_class: measurement
      device_class: temperature
      unit_of_measurement: "째F"
      state: "{{ states('input_number.water_temperature_target') | float + states('input_number.water_temperature_tolerance') | float }}"

    - name: "Water Temp Threshold Min"
      unique_id: watertemp_setmin
      icon: mdi:water-thermometer
      state_class: measurement
      device_class: temperature
      unit_of_measurement: "째F"
      state: "{{ states('input_number.water_temperature_target') | float - states('input_number.water_temperature_tolerance') | float }}"

    ######################Nutrient Dosing Full Dose calculations#######################
    - name: "Duel Fuel 1 Full Dose"
      unique_id: duel_fuel_1_full_dose
      icon: mdi:tally-mark-1
      state_class: measurement
      device_class: volume
      unit_of_measurement: "ml"
      state: "{{ states('input_number.duel_fuel_1')|float * states('input_number.reservoir_volume')|float}}"

    - name: "Duel Fuel 2 Full Dose"
      unique_id: duel_fuel_2_full_dose
      icon: mdi:tally-mark-2
      state_class: measurement
      device_class: volume
      unit_of_measurement: "ml"
      state: "{{ states('input_number.duel_fuel_2')|float * states('input_number.reservoir_volume')|float}}"

    - name: "Vitathrive Full Dose"
      unique_id: vitathrive_full_dose
      icon: mdi:tally-mark-3
      state_class: measurement
      device_class: volume
      unit_of_measurement: "ml"
      state: "{{ states('input_number.vitathrive')|float * states('input_number.reservoir_volume')|float}}"

    - name: "Rezin Full Dose"
      unique_id: rezin_full_dose
      icon: mdi:tally-mark-4
      state_class: measurement
      device_class: volume
      unit_of_measurement: "ml"
      state: "{{ states('input_number.rezin')|float * states('input_number.reservoir_volume')|float}}"

    - name: "Massive Bloom Full Dose"
      unique_id: massive_bloom_full_dose
      icon: mdi:tally-mark-5
      state_class: measurement
      device_class: volume
      unit_of_measurement: "ml"
      state: "{{ states('input_number.massive_bloom')|float * states('input_number.reservoir_volume')|float}}"

    - name: "Liquid Weight Full Dose"
      unique_id: liquid_weight_full_dose
      icon: mdi:tally-mark-6
      state_class: measurement
      device_class: volume
      unit_of_measurement: "ml"
      state: "{{ states('input_number.liquid_weight')|float * states('input_number.reservoir_volume')|float}}"

    ###############################Dosing timer calculations##########################
    - name: "Duel Fuel 1 Dose Length"
      unique_id: duel_fuel_1_dose_length
      icon: mdi:timer-alert
      state_class: measurement
      device_class: duration
      unit_of_measurement: "seconds"
      state: "{{ states('sensor.duel_fuel_1_full_dose')|float / (states('input_number.peristaltic_pump_flow_rate')|float / 60 ) }}"
    - name: "Duel Fuel 2 Dose Length"
      unique_id: duel_fuel_2_dose_length
      icon: mdi:timer-alert
      state_class: measurement
      device_class: duration
      unit_of_measurement: "seconds"
      state: "{{ states('sensor.duel_fuel_2_full_dose')|float / (states('input_number.peristaltic_pump_flow_rate')|float / 60 )}}"
    - name: "Vitathrive Dose Length"
      unique_id: vitathrive_dose_length
      icon: mdi:timer-alert
      state_class: measurement
      device_class: duration
      unit_of_measurement: "seconds"
      state: "{{ states('sensor.vitathrive_full_dose')|float / (states('input_number.peristaltic_pump_flow_rate')|float / 60 )}}"
    - name: "Rezin Dose Length"
      unique_id: rezin_dose_length
      icon: mdi:timer-alert
      state_class: measurement
      device_class: duration
      unit_of_measurement: "seconds"
      state: "{{ states('sensor.rezin_full_dose')|float / (states('input_number.peristaltic_pump_flow_rate')|float / 60 )}}"
    - name: "Massive Bloom Dose Length"
      unique_id: massive_bloom_dose_length
      icon: mdi:timer-alert
      state_class: measurement
      device_class: duration
      unit_of_measurement: "seconds"
      state: "{{ states('sensor.massive_bloom_full_dose')|float / (states('input_number.peristaltic_pump_flow_rate')|float / 60 )}}"
    - name: "Liquid Weight Dose Length"
      unique_id: liquid_weight_dose_length
      icon: mdi:timer-alert
      state_class: measurement
      device_class: duration
      unit_of_measurement: "seconds"
      state: "{{ states('sensor.liquid_weight_full_dose')|float / (states('input_number.peristaltic_pump_flow_rate')|float / 60 ) }}"
    - name: "Flow Rate in Hours:Minutes:Seconds"
      unique_id: flowrateformatted
      state: >
        {% set s = states('input_number.peristaltic_pump_flow_rate') | float / 60 * 5|float %}  
        '%02d:%02d:%05.2f' % ((s/3600)|int, (s%3600/60), s | float)
